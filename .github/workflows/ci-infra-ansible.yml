name: CI Infra (Ansible)

on:
  workflow_call:
    inputs:
      runner_label:  { type: string,  default: "staging", required: false }
      use_self_hosted: { type: boolean, default: false,  required: false }
      run_yamllint:  { type: boolean, default: true,     required: false }
      run_molecule:  { type: boolean, default: false,    required: false }

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  infra-ci:
    name: infra-ci
    runs-on: ${{ inputs.use_self_hosted && fromJSON(format('["self-hosted","linux","{0}"]', inputs.runner_label)) || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint molecule[docker]

      - name: yamllint
        if: ${{ inputs.run_yamllint }}
        run: yamllint .

      - name: ansible-lint
        run: ansible-lint

      - name: Molecule (optionnel)
        if: ${{ inputs.run_molecule }}
        run: molecule test
